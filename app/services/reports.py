from google import generativeai as genai

MODEL = "gemini-2.5-flash"


def configure_gemini(api_key: str) -> None:
    """Настраивает использование Gemini."""
    genai.configure(api_key=api_key)


def format_task(task: dict) -> str:
    """Преобразует одно задание в строку для промпта."""
    return (
        f"- Задание «{task['name']}» "
        f"(направление: {task['direction']}, {task['text']})"
    )


def build_tasks_block(tasks: list[dict]) -> str:
    """Создаёт текстовый блок со списком заданий."""
    return "\n".join(format_task(task) for task in tasks)


def make_prompt_for_children(children: list[dict]) -> str:
    """Создаёт текстовый промпт для отчёта по одному ребёнку."""

    prompt = """
Сформируй краткие связные отчёты о прогрессе ребёнка.
Используй только имя ребёнка, без фамилии.
Не используй слова с корнем "учи": учиться, научился, обучение, изучение, обучился и любые производные.
Не используй слова, которые привязывают текст ко времени: сегодня, сейчас, в этот раз, недавно, далее и другие временные маркеры.
Пиши нейтрально, описывая только результаты и действия ребёнка.
Ограничение по длине от 50 символов и до двух предложений.

На основе списка выполненных заданий сформируй один связный абзац.
Не перечисляй задания по пунктам — объедини их в единый логичный текст.
Используй творческую формулировку, отражая, в чём проявились навыки ребёнка.

Для каждого ребёнка сделай отчёт, выведи их в виде нумерованнового списка

Пример желаемого стиля:
«Малик продолжил практиковаться в создании игр в Kodu Game Lab. Он разработал футбольную игру для двух игроков, реализовав управление для каждого игрока, а также создал карту уровня и логику победы и поражения, закрепляя навыки программирования игровых механик.»"""

    for i, child in enumerate(children, start=1):
        tasks_block = build_tasks_block(child["tasks"])

        prompt += f"""
Вот данные о ребёнке {i}:
Имя: {child['name']}
Выполненные задания:
{tasks_block}"""

    return prompt


def send_to_gemini(prompt: str) -> str:
    """Отправляет промпт в Gemini и возвращает текст ответа."""
    model = genai.GenerativeModel(model_name=MODEL)
    response = model.generate_content(prompt)
    return response.text.strip()
